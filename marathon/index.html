
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Marica Antonacci - marica.antonacci@ba.infn.it">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.10">
    
    
      
        <title>Deploy long running services on Marathon - Apache Mesos Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d6be258b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="green">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-marathon-web-ui" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Apache Mesos Tutorial" class="md-header__button md-logo" aria-label="Apache Mesos Tutorial" data-md-component="logo">
      
  <img src="../assets/logo_infn.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Apache Mesos Tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deploy long running services on Marathon
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/maricaantonacci/mesos-tutorial/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Apache Mesos Tutorial" class="md-nav__button md-logo" aria-label="Apache Mesos Tutorial" data-md-component="logo">
      
  <img src="../assets/logo_infn.png" alt="logo">

    </a>
    Apache Mesos Tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/maricaantonacci/mesos-tutorial/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Deploy long running services on Marathon
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Deploy long running services on Marathon
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-marathon-web-ui" class="md-nav__link">
    Using Marathon web UI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-and-load-balancing" class="md-nav__link">
    Scaling and load-balancing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#marathon-rest-api" class="md-nav__link">
    Marathon REST API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-groups" class="md-nav__link">
    Application groups
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-local-storage" class="md-nav__link">
    Using local storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#health-checks" class="md-nav__link">
    Health checks
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chronos/" class="md-nav__link">
        Execute scheduled jobs on Chronos
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/maricaantonacci/mesos-tutorial/edit/master/docs/marathon.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


  <h1>Deploy long running services on Marathon</h1>

<h2 id="using-marathon-web-ui">Using Marathon web UI<a class="headerlink" href="#using-marathon-web-ui" title="Permanent link">&para;</a></h2>
<p>Now, letâ€™s start using the Marathon GUI. Click on <strong>Create Application</strong>:</p>
<p><img alt="" src="../images/marathon_1.png" style="width:400px" /></p>
<p>We are presented with a window in which we can name and configure an application to run in Marathon.
Let's try to deploy the application packaged in the <a href="https://hub.docker.com/r/nginxdemos/hello/"><code>nginxdemos/hello</code></a> docker image.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This image allows to run a NGINX webserver that serves a simple page containing its hostname, IP address and port as wells as the request URI and the local time of the webserver.</p>
</div>
<p><img alt="" src="../images/marathon_2.png" /></p>
<p>Change the Network field value to <code>Bridged</code>:</p>
<p><img alt="" src="../images/marathon_3.png" /></p>
<p>and specify the port <code>80</code> in the <code>Ports</code> tab in order to map the container port <code>80</code> (where nginx is listening inside the container) to a host port. </p>
<p>Note that if you click on the <code>Json Mode</code> switch on the top right corner of the Application window you can see the <code>json</code> definition of your application:</p>
<p><img alt="" src="../images/marathon_4a.png" /></p>
<p>Then click on <strong>Create Application</strong>.</p>
<p><img alt="" src="../images/marathon_4.png" /></p>
<p>In a few moments you will see your application running.</p>
<p><img alt="" src="../images/marathon_5.png" /></p>
<p>Click on the name of the application in order to access the application details and menu:</p>
<p><img alt="" src="../images/marathon_6.png" /></p>
<p>Under the <code>instances</code> tab you can see the <code>ID</code> of your application instance and the <code>IP:port</code>URL to access the deployed service. Click on it and you will access the demo web server:</p>
<p><img alt="" src="../images/marathon_6.1.png" /></p>
<p>Now move to the Mesos web UI (port <code>5050</code>): you can see your running container under the <code>Active Tasks</code> window:</p>
<p><img alt="" src="../images/marathon_7.png" /></p>
<p>Clicking on the <code>Sandbox</code> link you will browse the container sandbox and read the <code>stdout</code> and <code>stderr</code> files:</p>
<p><img alt="" src="../images/marathon_8.png" /></p>
<p>Finally you can destroy your application:</p>
<p><img alt="" src="../images/marathon_9.png" /></p>
<h2 id="scaling-and-load-balancing">Scaling and load-balancing<a class="headerlink" href="#scaling-and-load-balancing" title="Permanent link">&para;</a></h2>
<div class="admonition note inline end">
<p class="admonition-title">Reference</p>
<p>Take a look at the official docs: <a href="https://mesosphere.github.io/marathon/docs/service-discovery-load-balancing.html">https://mesosphere.github.io/marathon/docs/service-discovery-load-balancing.html</a></p>
</div>
<p>When your app is up and running, you need a way to send traffic to it, from other applications on the same cluster, and from external clients.
In your mini-cluster <a href="https://github.com/mesosphere/marathon-lb"><code>Marathon-lb</code></a> provides port-based service discovery using <a href="http://www.haproxy.org/"><code>HAProxy</code></a>, a lightweight TCP/HTTP proxy.</p>
<p>Adding the label <code>HAPROXY_GROUP=external</code> to your application, you will expose your app on the Load Balancer (LB): services are exposed on their service port as defined in their Marathon definition.</p>
<p>Let's create again our application from <code>nginxdemos/hello</code> docker image, but this time we will add the label <code>HAPROXY_GROUP</code>:</p>
<p><img alt="" src="../images/marathon_10.png" /></p>
<p>Looking at the app <code>Configuration</code> we can see the service port assigned to our service (in this case it was <code>10000</code>).</p>
<p><img alt="" src="../images/marathon_11.png" /></p>
<p>Connect to the service port on your host: you will see the web server main page.</p>
<p><img alt="" src="../images/marathon_11b.png" /></p>
<p>Now let's scale our application in order to have 2 instances of the web server:</p>
<p><img alt="" src="../images/marathon_12.png" /></p>
<p>As you can see now we have two running docker containers, using two different host ports (11436 and 11849), but we can still use the service port <code>10000</code> managed by our <code>Marathon-lb</code>: client requests will be forwarded to each instance in turn.</p>
<p><img alt="" src="../images/marathon_13.png" /></p>
<p>You can verify that using the following command:</p>
<div class="highlight"><pre><span></span><code>curl --silent <span class="s2">&quot;http://192.168.28.151:10000&quot;</span><span class="p">|</span>grep <span class="s1">&#39;name&#39;</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Replace the IP <code>192.168.28.151</code>  with your VM IP and the port <code>10000</code> with the service port shown in the application <code>Configuration</code> tab. </p>
</div>
<p>You will see the following behaviour showing that the requests are managed by the two containers in turn:</p>
<p><img alt="" src="../images/marathon_14.png" style="width:800px;" /></p>
<h2 id="marathon-rest-api">Marathon REST API<a class="headerlink" href="#marathon-rest-api" title="Permanent link">&para;</a></h2>
<p>The following table reports the main API endpoints:</p>
<table>
<thead>
<tr>
<th align="left">API Endpoint</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">/v2/deployments</td>
<td align="left">Query for all running deployments on a Marathon instance ('GET')</td>
</tr>
<tr>
<td align="left">/v2/deployments/<dep-id></td>
<td align="left">Query for information about a specific deployment (<code>GET</code>)</td>
</tr>
<tr>
<td align="left">/v2/apps</td>
<td align="left">Query for all applications on a Marathon instance (<code>GET</code>) or create new applications (<code>POST</code>)</td>
</tr>
<tr>
<td align="left">/v2/apps/<app-id></td>
<td align="left">Query for information about a specific app (<code>GET</code>), update the configuration of an app (<code>PUT</code>), or delete an app (<code>DELETE</code>)</td>
</tr>
<tr>
<td align="left">/v2/groups</td>
<td align="left">Query for all application groups on a Marathon instance (<code>GET</code>) or create a new application group (<code>POST</code>)</td>
</tr>
<tr>
<td align="left">/v2/groups/<group-id></td>
<td align="left">Query for information about a specific application group (<code>GET</code>), update the configuration of an application group (<code>PUT</code>), or delete an application group (<code>DELETE</code>)</td>
</tr>
</tbody>
</table>
<p>We will be using these endpoints in the following sections.</p>
<h2 id="application-groups">Application groups<a class="headerlink" href="#application-groups" title="Permanent link">&para;</a></h2>
<p>Application groups are used to partition applications into disjoint sets for management.
Groups make it easy to manage logically related applications and allow you to perform actions on the entire group, such as scaling. </p>
<p>Marathon takes dependencies into account while starting, stopping, upgrading and scaling.</p>
<p><img alt="" src="../images/marathon_app_group.png" /></p>
<p>Here is the <code>json</code> definition of this application group:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Replace the value of the env var <code>PMA_HOST</code> at line 52 with your VM IP.</p>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/dbaas&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;apps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/dbaas/db&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;container&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DOCKER&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;image&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mariadb:10.3&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;network&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;portMappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;containerPort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3306</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;servicePort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10006</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;protocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;MYSQL_ROOT_PASSWORD&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3cret&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;MYSQL_USER&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;phpma&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;MYSQL_PASSWORD&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3cret&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;labels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;HAPROXY_GROUP&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;instances&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;cpus&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;mem&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/dbaas/phpmyadmin&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;container&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DOCKER&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;image&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;phpmyadmin/phpmyadmin&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;network&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;portMappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;containerPort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;servicePort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10008</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;protocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;/dbaas/db&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="w">        </span><span class="nt">&quot;PMA_HOST&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.28.151&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="w">        </span><span class="nt">&quot;PMA_PORT&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10006&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;labels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;HAPROXY_GROUP&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;instances&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;cpus&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;mem&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>Look at the definition of the application group:</p>
<ul>
<li>
<p>in both applications we have set some <strong>environment variables</strong> (json tag <code>env</code>):</p>
<ul>
<li><code>MYSQL_ROOT_PASSWORD</code>, <code>MYSQL_USER</code>, <code>MYSQL_PASSWORD</code> are set for the first application <code>db</code>: these environment variables are required by the Official <a href="https://hub.docker.com/_/mariadb"><code>mariadb</code></a> docker image;</li>
<li><code>PMA_HOST</code>, <code>PMA_PORT</code> are set for the second application <code>phpmyadmin</code>: these environment variables are required by the Official <a href="https://hub.docker.com/r/phpmyadmin/phpmyadmin/"><code>phpmyadmin</code></a> docker image.</li>
</ul>
</li>
<li>
<p>the <code>phpmyadmin</code> app depends on the <code>db</code> app: the dependency is defined at lines 48-50</p>
<ul>
<li>this services communicates with the <code>db</code> using the service port (10006) defined at line 14.</li>
</ul>
</li>
</ul>
<p>Save the json above in a file, e.g. <code>dbaas.json</code>, and deploy it using the <code>/v2/groups</code> endpoint:</p>
<div class="highlight"><pre><span></span><code>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -X POST http://localhost:8080/v2/groups -d@dbaas.json
</code></pre></div>
<p>Through the Marathon web UI you can monitor your deployment:</p>
<p><img alt="" src="../images/marathon_group_1.png" /></p>
<p>Click on the <code>dbaas</code> folder to see the applications of the group:</p>
<p><img alt="" src="../images/marathon_group_2.png" /></p>
<p>When they are running you will be able to access the phpmyadmin web tool on port <code>10008</code> of your VM:</p>
<p><img alt="" src="../images/marathon_group_3.png" /></p>
<p>Use the <code>root</code> credentials to access the administrative panel of the DBMS (username root, password as set in the json at line ):</p>
<p><img alt="" src="../images/marathon_group_4.png" /></p>
<p>Let's create a new database <code>test</code>:</p>
<p><img alt="" src="../images/marathon_group_5.png" /></p>
<p>The new database has been stored in the <code>db</code> container...What happens if you restart the <code>db</code> app?</p>
<p>Click on button <code>Restart</code> in the <code>db</code> application menu:</p>
<p><img alt="" src="../images/marathon_group_6.png" /></p>
<p>Marathon creates a new instance of our application, that means a new container; once the new container is up and running the old one is destroyed.</p>
<p><img alt="" src="../images/marathon_group_7.png" /></p>
<p>Since the database <code>test</code> was stored in the old container, we lose our data:</p>
<p><img alt="" src="../images/marathon_group_8.png" /> </p>
<h2 id="using-local-storage">Using local storage<a class="headerlink" href="#using-local-storage" title="Permanent link">&para;</a></h2>
<p>Modify the json definition of the <code>db</code> application to request a volume:</p>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="o">{</span>
  <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;/dbaas&quot;</span>,
  <span class="s2">&quot;apps&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;/dbaas/db&quot;</span>,
      <span class="s2">&quot;container&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;DOCKER&quot;</span>,
        <span class="s2">&quot;docker&quot;</span>: <span class="o">{</span>
          <span class="s2">&quot;image&quot;</span>: <span class="s2">&quot;mariadb:10.3&quot;</span>,
          <span class="s2">&quot;network&quot;</span>: <span class="s2">&quot;BRIDGE&quot;</span>,
          <span class="s2">&quot;portMappings&quot;</span>: <span class="o">[</span>
            <span class="o">{</span>
              <span class="s2">&quot;containerPort&quot;</span>: <span class="m">3306</span>,
              <span class="s2">&quot;servicePort&quot;</span>: <span class="m">10006</span>,
              <span class="s2">&quot;protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>
            <span class="o">}</span>
          <span class="o">]</span>
        <span class="o">}</span>,
<span class="hll">        <span class="s2">&quot;volumes&quot;</span>: <span class="o">[</span>
</span><span class="hll">          <span class="o">{</span>
</span><span class="hll">            <span class="s2">&quot;containerPath&quot;</span>: <span class="s2">&quot;/var/lib/mysql&quot;</span>,
</span><span class="hll">            <span class="s2">&quot;mode&quot;</span>: <span class="s2">&quot;RW&quot;</span>,
</span><span class="hll">            <span class="s2">&quot;hostPath&quot;</span>: <span class="s2">&quot;/tmp/mysql&quot;</span>
</span><span class="hll">          <span class="o">}</span>
</span><span class="hll">        <span class="o">]</span>
</span>      <span class="o">}</span>,
      <span class="s2">&quot;env&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;MYSQL_ROOT_PASSWORD&quot;</span>: <span class="s2">&quot;s3cret&quot;</span>,
        <span class="s2">&quot;MYSQL_USER&quot;</span>: <span class="s2">&quot;phpma&quot;</span>,
        <span class="s2">&quot;MYSQL_PASSWORD&quot;</span>: <span class="s2">&quot;s3cret&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;labels&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;HAPROXY_GROUP&quot;</span>: <span class="s2">&quot;external&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;instances&quot;</span>: <span class="m">1</span>,
      <span class="s2">&quot;cpus&quot;</span>: <span class="m">0</span>.5,
      <span class="s2">&quot;mem&quot;</span>: <span class="m">512</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;/dbaas/phpmyadmin&quot;</span>,
      <span class="s2">&quot;container&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;DOCKER&quot;</span>,
        <span class="s2">&quot;docker&quot;</span>: <span class="o">{</span>
          <span class="s2">&quot;image&quot;</span>: <span class="s2">&quot;phpmyadmin/phpmyadmin&quot;</span>,
          <span class="s2">&quot;network&quot;</span>: <span class="s2">&quot;BRIDGE&quot;</span>,
          <span class="s2">&quot;portMappings&quot;</span>: <span class="o">[</span>
            <span class="o">{</span>
              <span class="s2">&quot;containerPort&quot;</span>: <span class="m">80</span>,
              <span class="s2">&quot;servicePort&quot;</span>: <span class="m">10008</span>,
              <span class="s2">&quot;protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>
            <span class="o">}</span>
          <span class="o">]</span>
        <span class="o">}</span>
      <span class="o">}</span>,
      <span class="s2">&quot;dependencies&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;/dbaas/db&quot;</span>
      <span class="o">]</span>,
      <span class="s2">&quot;env&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;PMA_HOST&quot;</span>: <span class="s2">&quot;192.168.28.151&quot;</span>,
        <span class="s2">&quot;PMA_PORT&quot;</span>: <span class="s2">&quot;10006&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;labels&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;HAPROXY_GROUP&quot;</span>: <span class="s2">&quot;external&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;instances&quot;</span>: <span class="m">1</span>,
      <span class="s2">&quot;cpus&quot;</span>: <span class="m">0</span>.1,
      <span class="s2">&quot;mem&quot;</span>: <span class="m">256</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
Lines <code>19-25</code> define a bind-mount volume:</p>
<div class="highlight"><pre><span></span><code>docker inspect <span class="k">$(</span>docker ps -q --filter <span class="nv">ancestor</span><span class="o">=</span>mariadb:10.3<span class="k">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>...
            <span class="s2">&quot;Binds&quot;</span>: <span class="o">[</span>
                <span class="s2">&quot;/tmp/mysql:/var/lib/mysql:rw&quot;</span>,
                <span class="s2">&quot;/tmp/mesos/slaves/692a979a-a998-4dd4-b059-8da9bfdf706d-S0/frameworks/692a979a-a998-4dd4-b059-8da9bfdf706d-0001/executors/dbaas_db.cb02ea99-cc5e-11eb-b551-0242ac140004/runs/34b09a76-9558-4429-bf56-61aeb8d0713a:/mnt/mesos/sandbox&quot;</span>
            <span class="o">]</span>,
...
</code></pre></div>
<p>Update your deployment with a <code>PUT</code> request:</p>
<div class="highlight"><pre><span></span><code>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -X PUT http://localhost:8080/v2/groups -d@dbaas.json
</code></pre></div>
<p>Now repeat the steps describe above: create a database and then restart the <code>db</code> application (you can use the Marathon web ui).</p>
<p>The database will survive if the db container is re-created.</p>
<p><strong>Note that this is not sufficient to ensure data persistence for your applications. In a multi-node cluster, if the node where your container is running fails, it will be re-deployed on another node and it will not find the data stored previously.</strong></p>
<p>In order to make your apps more fault-tolerant, you can use an external storage service, such as Ceph or Amazon EBS, to create a persistent volume that follows your application instance.</p>
<p>This topic is beyond the scope of this basic tutorial. See the <a href="https://mesosphere.github.io/marathon/docs/external-volumes.html">docs</a> for more details.</p>
<h2 id="health-checks">Health checks<a class="headerlink" href="#health-checks" title="Permanent link">&para;</a></h2>
<p>Using the web UI click on the <code>Health Checks</code> tab to setup your checks:</p>
<p><img alt="" src="../images/health_checks_1.png" />  </p>
<p>Using the REST APIs add the <code>healthChecks</code> definition in the application json as in the following example:</p>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
  <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;nginx&quot;</span>,
  <span class="s2">&quot;cpus&quot;</span>: <span class="m">0</span>.25,
  <span class="s2">&quot;mem&quot;</span>: <span class="m">128</span>,
  <span class="s2">&quot;disk&quot;</span>: <span class="m">0</span>,
  <span class="s2">&quot;instances&quot;</span>: <span class="m">1</span>,
  <span class="s2">&quot;container&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;docker&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;image&quot;</span>: <span class="s2">&quot;nginx&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;DOCKER&quot;</span>,
    <span class="s2">&quot;portMappings&quot;</span>: <span class="o">[</span>
      <span class="o">{</span>
        <span class="s2">&quot;containerPort&quot;</span>: <span class="m">80</span>,
        <span class="s2">&quot;protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>
      <span class="o">}</span>
    <span class="o">]</span>
  <span class="o">}</span>,
  <span class="s2">&quot;networks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;mode&quot;</span>: <span class="s2">&quot;container/bridge&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">&quot;healthChecks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;protocol&quot;</span>: <span class="s2">&quot;HTTP&quot;</span>,
      <span class="s2">&quot;path&quot;</span>: <span class="s2">&quot;/&quot;</span>,
      <span class="s2">&quot;portIndex&quot;</span>: <span class="m">0</span>,
      <span class="s2">&quot;gracePeriodSeconds&quot;</span>: <span class="m">300</span>,
      <span class="s2">&quot;intervalSeconds&quot;</span>: <span class="m">60</span>,
      <span class="s2">&quot;timeoutSeconds&quot;</span>: <span class="m">20</span>,
      <span class="s2">&quot;maxConsecutiveFailures&quot;</span>: <span class="m">3</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>If the checks are passed, the application status will be <code>healthy</code> and you will get a green bar near your instance:</p>
<p><img alt="" src="../images/health_checks_2.png" /></p>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../intro/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Introduction
            </div>
          </div>
        </a>
      
      
        
        <a href="../chronos/" class="md-footer__link md-footer__link--next" aria-label="Next: Execute scheduled jobs on Chronos" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Execute scheduled jobs on Chronos
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 INFN
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "toc.integrate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.e3b2bf44.min.js"></script>
      
    
  </body>
</html>